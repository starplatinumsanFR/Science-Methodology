<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Quicksort Performance by Thread Level (Mean ± 95% CI)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="meta">
      <h2 style="margin: 0 0 6px 0;">Parallel Quicksort Performance by Thread Level</h2>
      <small>Each point shows the mean runtime over repeated runs for a given thread level. The shaded region + whiskers show the 95% confidence interval on the mean runtime.</small>
    </div>

    <svg width="900" height="520"></svg>
    <div class="tooltip" id="tip"></div>

    <div class="note">If this chart doesn’t load: run the HTML, CSS and CSV file with a local server so it can be fetched.</div>

    <script>
      const CSV_PATH = "parallel_quicksort_threads_ci_min.csv";

      const svg = d3.select("svg");
      const tip = d3.select("#tip");

      const margin = {top: 70, right: 220, bottom: 60, left: 90};
      const width  = +svg.attr("width") - margin.left - margin.right;
      const height = +svg.attr("height") - margin.top - margin.bottom;

      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      const series = [
        {name:"Sequential", meanKey:"seq_mean", lowKey:"seq_ci_low", highKey:"seq_ci_high", color:"#1f77b4"},
        {name:"Parallel", meanKey:"par_mean", lowKey:"par_ci_low", highKey:"par_ci_high", color:"#d62728"},
        {name:"Built-in", meanKey:"builtin_mean", lowKey:"builtin_ci_low", highKey:"builtin_ci_high", color:"#2ca02c"},
      ];

      function fmt3(x){ return (x == null || Number.isNaN(x)) ? "NA" : (+x).toFixed(3); }

      d3.csv(CSV_PATH, d => ({
        thread: String(+d.Thread_Level),
        N: +d.N,

        seq_mean: +d.seq_mean, seq_ci_low: +d.seq_ci_low, seq_ci_high: +d.seq_ci_high,
        par_mean: +d.par_mean, par_ci_low: +d.par_ci_low, par_ci_high: +d.par_ci_high,
        builtin_mean: +d.builtin_mean, builtin_ci_low: +d.builtin_ci_low, builtin_ci_high: +d.builtin_ci_high,
      })).then(data => {
        data.sort((a,b) => (+a.thread) - (+b.thread));

        const threads = data.map(d => d.thread);
        const Nfixed = data.length ? data[0].N : null;

        const x = d3.scaleBand()
          .domain(threads)
          .range([0, width])
          .padding(0.25);

        const yMin = d3.min(data, d => d3.min(series, s => d[s.lowKey]));
        const yMax = d3.max(data, d => d3.max(series, s => d[s.highKey]));

        const y = d3.scaleLinear()
          .domain([Math.max(0, yMin - 0.15), yMax + 0.15])
          .nice()
          .range([height, 0]);

        svg.append("text")
          .attr("x", margin.left)
          .attr("y", 28)
          .attr("font-size", 14)
          .attr("fill", "#111")
          .text(`N = ${Nfixed?.toLocaleString?.() ?? "?"} (fixed), CI from Python (t-based, 95%)`);

        g.append("g")
          .attr("class", "grid")
          .call(d3.axisLeft(y).ticks(8).tickSize(-width).tickFormat(""))
          .selectAll("line");

        g.append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x))
          .call(g => g.selectAll("text").style("font-size","13px"));

        g.append("g")
          .call(d3.axisLeft(y).ticks(8));

        svg.append("text")
          .attr("x", margin.left + width/2)
          .attr("y", margin.top + height + 48)
          .attr("text-anchor", "middle")
          .attr("fill", "#000")
          .attr("font-size", 14)
          .text("Thread level (compile-time THREAD_LEVEL)");

        svg.append("text")
          .attr("x", 18)
          .attr("y", margin.top + height/2)
          .attr("transform", `rotate(-90, 18, ${margin.top + height/2})`)
          .attr("text-anchor", "middle")
          .attr("fill", "#000")
          .attr("font-size", 14)
          .text("Runtime (seconds)");

        const xMid = d => x(d.thread) + x.bandwidth()/2;

        series.forEach(s => {
          const area = d3.area()
            .x(d => xMid(d))
            .y0(d => y(d[s.lowKey]))
            .y1(d => y(d[s.highKey]));

          g.append("path")
            .datum(data)
            .attr("class", "ci-band")
            .attr("fill", s.color)
            .attr("opacity", 0.12)
            .attr("d", area);

          const line = d3.line()
            .x(d => xMid(d))
            .y(d => y(d[s.meanKey]));

          g.append("path")
            .datum(data)
            .attr("class","line")
            .attr("stroke", s.color)
            .attr("d", line);

          const cap = Math.max(6, x.bandwidth() * 0.22);

          const eb = g.selectAll(`.eb-${s.meanKey}`)
            .data(data)
            .enter()
            .append("g")
            .attr("transform", d => `translate(${xMid(d)},0)`);

          eb.append("line")
            .attr("class","errorbar")
            .attr("stroke", s.color)
            .attr("x1", 0).attr("x2", 0)
            .attr("y1", d => y(d[s.lowKey]))
            .attr("y2", d => y(d[s.highKey]))
            .attr("opacity", 0.9);

          eb.append("line")
            .attr("class","errorcap")
            .attr("stroke", s.color)
            .attr("x1", -cap/2).attr("x2", cap/2)
            .attr("y1", d => y(d[s.lowKey]))
            .attr("y2", d => y(d[s.lowKey]))
            .attr("opacity", 0.9);

          eb.append("line")
            .attr("class","errorcap")
            .attr("stroke", s.color)
            .attr("x1", -cap/2).attr("x2", cap/2)
            .attr("y1", d => y(d[s.highKey]))
            .attr("y2", d => y(d[s.highKey]))
            .attr("opacity", 0.9);

          g.selectAll(`.dot-${s.meanKey}`)
            .data(data)
            .enter()
            .append("circle")
            .attr("r", 4.5)
            .attr("cx", d => xMid(d))
            .attr("cy", d => y(d[s.meanKey]))
            .attr("fill", s.color)
            .attr("stroke", "white")
            .attr("stroke-width", 1.2)
            .on("mousemove", (event, d) => {
              const mean = d[s.meanKey];
              const lo = d[s.lowKey];
              const hi = d[s.highKey];
              const halfWidth = (hi - lo) / 2;

              tip
                .style("opacity", 1)
                .style("left", (event.clientX + 14) + "px")
                .style("top", (event.clientY + 14) + "px")
                .html(`
                  <div class="t">${s.name} THREAD_LEVEL = ${d.thread}</div>
                  <div><b>mean:</b> ${fmt3(mean)} s</div>
                  <div><b>95% CI:</b> [${fmt3(lo)}, ${fmt3(hi)}] s</div>
                  <div><b>CI half-width:</b> ±${fmt3(halfWidth)} s</div>
                `);
            })
            .on("mouseleave", () => tip.style("opacity", 0));
        });

        const legend = svg.append("g")
          .attr("transform", `translate(${margin.left + width + 20}, ${margin.top + 10})`);

        legend.append("text")
          .attr("x", 0).attr("y", 0)
          .attr("fill", "#111")
          .attr("font-size", 14)
          .attr("font-weight", 700)
          .text("Algorithm");

        series.forEach((s,i)=>{
          const row = legend.append("g").attr("transform", `translate(0, ${18 + i*26})`);
          row.append("rect")
            .attr("width", 14).attr("height", 14)
            .attr("fill", s.color).attr("opacity", 0.65);
          row.append("text")
            .attr("x", 20).attr("y", 12)
            .attr("class","legend")
            .text(s.name);
        });

        const ctx = legend.append("g").attr("transform", `translate(0, ${18 + series.length*26 + 18})`);
        ctx.append("text")
          .attr("fill", "#222")
          .attr("font-size", 13)
          .attr("font-weight", 700)
          .text("CI encoding");

        ctx.append("text")
          .attr("y", 18)
          .attr("fill", "#333")
          .attr("font-size", 12.5)
          .text("- Shaded band = 95% CI");

        ctx.append("text")
          .attr("y", 36)
          .attr("fill", "#333")
          .attr("font-size", 12.5)
          .text("- Whiskers = 95% CI");

        ctx.append("text")
          .attr("y", 54)
          .attr("fill", "#333")
          .attr("font-size", 12.5)
          .text("- Dot/line = mean");

      }).catch(err => {
        console.error(err);
        alert("CSV not loaded. Put parallel_quicksort_threads_ci_min.csv next to this HTML and use a local server (Live Server).");
      });
    </script>
  </body>
</html>
